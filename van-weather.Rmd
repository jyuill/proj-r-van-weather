---
title: "Vancouver Weather Analysis"
output:
  html_document:
    df_print: paged
---

```{r SETUP, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, 
                      warning=FALSE, 
                      message=FALSE)

library(tidyverse)
library(scales)
library(PerformanceAnalytics)
library(lubridate)
library(plotly)

```

# Intro {.tabset}

Basic analysis of Vancouver weather patterns:

* from [Govt. of Canada Historical Weather](http://climate.weather.gc.ca/historical_data/search_historic_data_e.html) Data website
* monthly
* precipitation, temperature

## Data Collection

Data is collected from Govt of Canada website:

1. search: http://climate.weather.gc.ca/historical_data/search_historic_data_e.html
2. specify station as containing 'vancouver harbour'
3. select 'daily', select 'year'
4. 'Go' goes to a page to access results for year

(process is automated in 'van-weather-import.R')

```{r IMPORT DATA}
## get latest data using van-weather-import.R
## import saved data
vw_data <- read_csv("input/van-hrbr-weather.csv")

## convert Year, Month to factors for better charting
vw_data$Year <- as.factor(vw_data$Year)
vw_data$Month <- as.factor(vw_data$Month)
#vw_data$Day <- as.factor(vw_data$Day)

```

**Earliest date:** *`r min(vw_data$Date)`* <br />
**Most recent date:** *`r max(vw_data$Date)`*

Check data structure:

```{r DATA STRUCTURE}
str(vw_data)

```

Earliest date: `r min(vw_data$Date)` <br />
Most recent date: `r max(vw_data$Date)`

Check Data Relationships

* uses PerformanceAnalytics package

```{r DATA RELATIONSHIPS}
chart.Correlation(vw_data[,c(5,6,7,8)], histogram = TRUE)

```

```{r TS1}
## time series chart from Performance Analytics pkg - not really better than just using ggplot2
# vw_ts <- data.frame(vw_data)
# row.names(vw_ts) <- vw_ts$Date
# chart.TimeSeries(vw_ts[,c(5,6,7,8), drop=FALSE])
```

## Precipitation 

### Monthly precipitation data: Averages

```{r MONTHLY PRECIP}
## Monthly precipitation for each month, each year
vw.precip.mth.yr <- vw_data %>% mutate(precip.day=ifelse(Total.Precip>0,1,0)) %>% 
  group_by(Year, Month) %>%
  summarize(ttl_precip=sum(Total.Precip, na.rm=TRUE),
            precip_days=sum(precip.day, na.rm=TRUE))
```


```{r MONTHLY PRECIP COMBINED}
vw.precip.mth <- vw.precip.mth.yr %>% group_by(Month) %>%
  summarize(ave_precip=mean(ttl_precip, na.rm=TRUE)) %>%
  mutate(pc_rank=percent_rank(ave_precip),
         pc=ave_precip/sum(ave_precip),
         rank=rank(desc(ave_precip)))

## filter for current year to overlay current year metrics on chart
vw.precip.mth.curr.yr <- vw.precip.mth.yr %>% filter(Year==year(Sys.Date()))
## need to have full 12 months for chart (even though some empty)
## get highest month with data in current year
fms <- max(as.numeric(vw.precip.mth.curr.yr$Month))+1
## create data frame for blank months
vw.precip.yr.future.mth <- data.frame(Year='2019',
                                      Month=c(fms:12),
                                       ttl_precip=NA,
                                      precip_days=NA)
## convert Month field in current yr from factor to integer for binding
vw.precip.mth.curr.yr$Month <- as.integer(vw.precip.mth.curr.yr$Month)
## add blank rows to current yr
vw.precip.mth.curr.yr <- bind_rows(vw.precip.mth.curr.yr,
                                    vw.precip.yr.future.mth) 

## Ave precip by month ####
chart.title <- "Average Precipitation by Month (red marker is curr. yr.)"
ggplot(vw.precip.mth, aes(x=Month, y=ave_precip))+geom_col()+
  geom_point(data=vw.precip.mth.curr.yr, aes(x=Month, y=ttl_precip),shape=18, color='red', size=5)+
  scale_y_continuous(expand=c(0,0))+
  ggtitle(chart.title)+theme_classic()
## Ave precip by month in order
chart.title <- "Months Ranked by Ave. Precipitation"
ggplot(vw.precip.mth, aes(x=reorder(Month, -ave_precip), y=ave_precip))+geom_col()+
  ggtitle(chart.title)+theme_classic()

```

#### Data by Month - ranked in order of highest precipitation

```{r MONTHLY PRECIP TABLE}
vw.precip.mth.rank <- vw.precip.mth %>% arrange(rank)
vw.precip.mth.rank
```

### Monthly Preciptiation: Ranges

```{r}
## Distribution of precipitation by month ####

## Range in precipitation by month ####
chart.title <- "Monthly Precip. Ranges during Period (Red markers: current yr.)"
ggplot(vw.precip.mth.yr, aes(x=Month, y=ttl_precip))+geom_boxplot()+
  geom_point(data=vw.precip.mth.curr.yr, aes(x=Month, y=ttl_precip),shape=18, color='red', size=5)+
  ggtitle(chart.title)+theme_classic()
## Range in precip days by month
chart.title <- "Monthly Rainy Days Ranges during Period (Red markers: current yr.)"
ggplot(vw.precip.mth.yr, aes(x=Month, y=precip_days))+geom_boxplot()+
  geom_point(data=vw.precip.mth.curr.yr, aes(x=Month, y=precip_days),shape=18, color='red', size=5)+
  ggtitle(chart.title)+theme_classic()
```


### Current Month Precipitation

```{r CURRENT MTH Precip}
## get name of current month
curr.mth <- month.name[month(Sys.Date())]

## filter monthly data set for current month only
vw.precip.mth.curr <- vw.precip.mth.yr %>% filter(Month==month(Sys.Date())) %>%
  arrange(desc(Year)) ## sort by year to get latest

## get recent years for current month precipitation
recentXyr <- 12
vw.precip.mth.curr.recent <- vw.precip.mth.curr[1:recentXyr,]
chart.title <- paste0(curr.mth, " Rain for each Year (last ",recentXyr, " years - with ave.)")
ggplot(vw.precip.mth.curr.recent, aes(x=Year, y=ttl_precip))+geom_bar(stat='identity')+
  geom_hline(yintercept=mean(vw.precip.mth.curr.recent$ttl_precip), linetype='dashed')+
  scale_y_continuous(expand=c(0,0))+theme_classic()+
  ggtitle(chart.title)

## show years in order of precipitation for current month
vw.precip.mth.curr <- vw.precip.mth.yr %>% filter(Month==month(Sys.Date())) %>%
  arrange(desc(ttl_precip)) ## sort by precipitation
topXyr <- 15
vw.precip.mth.curr.top <- vw.precip.mth.curr[1:topXyr,]

chart.title <- paste0(curr.mth, " Ranked by Precipitation (top ",topXyr," yrs)")
ggplot(vw.precip.mth.curr.top, aes(x=reorder(Year, -ttl_precip), y=ttl_precip))+geom_col()+
  scale_y_continuous(expand=c(0,0))+theme_classic()+
  ggtitle(chart.title)

## get percentiles for current mth
vw.precip.mth.curr.pc <- vw.precip.mth.curr %>% ungroup() %>% arrange(ttl_precip) %>%
  #mutate(precip.pc=quantile(ttl_precip))
  mutate(precip.rank=rank(ttl_precip),
         precip.pc=precip.rank/max(precip.rank),
         cum.dist=cume_dist(ttl_precip),
         pc.rank=percent_rank(ttl_precip))

```

### Monthly Comparison YoY

For each month, what has been the pattern in precipitation over the years?

```{r PLOT MONTHS YOY, fig.width=5, fig.height=14}
## show each mth side-by-side YoY to see patterns, highs, lows

## facet_wrap is condensed but too many years to be able to read x axis
# ggplot(vw.precip.mth.yr, aes(x=Year, y=ttl_precip))+geom_bar(stat='identity')+
#   facet_wrap(Month~.)+
#   theme(axis.text.x  = element_text(angle=90, vjust=0.5))

## facet_grid is too wide and short unless re-sized
ggplot(vw.precip.mth.yr, aes(x=Year, y=ttl_precip))+geom_bar(stat='identity')+
  facet_grid(Month~.)+
  theme_bw()+
  theme(axis.text.x  = element_text(angle=90, vjust=0.5))
```

## Temperature

### Monthly average temperature

```{r MONTHLY TEMP}
## Monthly precipitation for each month, each year
vw.temp.mth.yr <- vw_data %>% 
  group_by(Year, Month) %>%
  summarize(ave_temp=mean(Mean.Temp, na.rm=TRUE),
            ave_max_temp=mean(Max.Temp, na.rm=TRUE),
            ave_min_temp=mean(Min.Temp, na.rm=TRUE),
            max_temp=max(Max.Temp, na.rm=TRUE),
            min_temp=min(Min.Temp, na.rm=TRUE))

#is.nan(vw.temp.mth.yr$ave_max_temp)
#vw.temp.mth.yr %>% filter(max_temp==-Inf)
## need to clean up missing values
## even with na.rm used above, if there are only NA for a given month, 
##  it will return NaN for mean and Inf or -Inf for min/max
## clean up
vw.temp.mth.yr <- vw.temp.mth.yr %>% mutate(
  ave_temp=ifelse(is.nan(ave_temp),NA,ave_temp),
  ave_max_temp=ifelse(is.nan(ave_max_temp),NA,ave_max_temp),
  ave_min_temp=ifelse(is.nan(ave_min_temp),NA,ave_min_temp),
  max_temp=ifelse(max_temp==-Inf|max_temp==Inf,NA, max_temp),
  min_temp=ifelse(min_temp==-Inf|min_temp==Inf,NA, min_temp)
)

```

```{r MONTHLY TEMP COMBINED MONTHS ACROSS YEARS}
vw.temp.mth <- vw.temp.mth.yr %>% group_by(Month) %>%
  summarize(ave_temp=mean(ave_temp, na.rm=TRUE),
            ave_max_temp=mean(ave_max_temp, na.rm=TRUE),
            ave_min_temp=mean(ave_min_temp, na.rm=TRUE)) %>%
  mutate(pc_rank=percent_rank(ave_temp),
         rank=rank(desc(ave_temp)))

## filter for current year to overlay current year metrics on chart
vw.temp.mth.curr.yr <- vw.temp.mth.yr %>% filter(Year==year(Sys.Date()))
## need to have full 12 months for chart (even though some empty)
## get highest month with data in current year
fms <- max(as.numeric(vw.temp.mth.curr.yr$Month))+1
## create data frame for blank months
vw.temp.yr.future.mth <- data.frame(Year=year(Sys.Date()),
                                      Month=c(fms:12))
## convert Month field in current yr from factor to integer for binding
vw.temp.mth.curr.yr$Year <- as.integer(vw.temp.mth.curr.yr$Year)
vw.temp.mth.curr.yr$Month <- as.integer(vw.temp.mth.curr.yr$Month)

## add blank rows to current yr
vw.temp.mth.curr.yr <- bind_rows(vw.temp.mth.curr.yr,
                                    vw.temp.yr.future.mth) 

## Ave temp by month ####
chart.title <- "Average Temp. Month (blue is ave. min/max; red marker is curr. yr.)"
ggplot(vw.temp.mth, aes(x=Month, y=ave_temp))+geom_col()+
  geom_errorbar(aes(ymin=ave_min_temp, ymax=ave_max_temp), width=.2,
                 position=position_dodge(.9), color='blue')+
  geom_point(data=vw.temp.mth.curr.yr, aes(x=Month, y=ave_temp),shape=18, color='red', size=5)+
  scale_y_continuous(expand=c(0,0))+
  ggtitle(chart.title)+theme_classic()
## Ave precip by month in order
chart.title <- "Months Ranked by Ave. Temp"
ggplot(vw.temp.mth, aes(x=reorder(Month, -ave_temp), y=ave_temp))+geom_col()+
  ggtitle(chart.title)+theme_classic()

```

### Monthly Temperatures: Ranges

```{r TEMPERATURE RANGES}
## Distribution of temperature by month ####

## Range in temperature by month ####
chart.title <- "Monthly Temp. Ranges during Period (Red markers: current yr.)"
ggplot(vw.temp.mth.yr, aes(x=Month, y=ave_temp))+geom_boxplot()+
  geom_point(data=vw.temp.mth.curr.yr, aes(x=Month, y=ave_temp),shape=18, color='red', size=5)+
  ggtitle(chart.title)+theme_classic()
```

### Monthly Temperature Trends over Years

```{r MONTHLY TEMP TRENDS}
## annual trends in month-by-month temp
chart.title <- "Ave. Mthly Temps. All Years"
## need to convert Month to integer for line chart
vw.temp.mth.yr$Month <- as.integer(vw.temp.mth.yr$Month)
## set chart to variable for use with plotly
plot.mth.yr <- ggplot(vw.temp.mth.yr, aes(x=Month, y=ave_temp, color=Year))+geom_line()+scale_x_continuous(breaks=c(1:12))+
  theme_classic()+ggtitle(chart.title)
## use plotly for interaction such as highlight specific years
ggplotly(plot.mth.yr)

```

### Monthly Temp. Comparison YoY

For each month, what has been the pattern in ave. temperature over the years?

```{r PLOT MONTHS YOY TEMP, fig.width=5, fig.height=14}
## show each mth side-by-side YoY to see patterns, highs, lows

## facet_wrap is condensed but too many years to be able to read x axis
# ggplot(vw.precip.mth.yr, aes(x=Year, y=ttl_precip))+geom_bar(stat='identity')+
#   facet_wrap(Month~.)+
#   theme(axis.text.x  = element_text(angle=90, vjust=0.5))

## facet_grid is too wide and short unless re-sized
ggplot(vw.temp.mth.yr, aes(x=Year, y=ave_temp))+geom_col()+
  facet_grid(Month~.)+
  theme_bw()+
  theme(axis.text.x  = element_text(angle=90, vjust=0.5))
  
```

